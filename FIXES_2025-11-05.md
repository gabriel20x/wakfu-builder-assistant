# Fixes Aplicados - 2025-11-05

**Problema Original**: Happy Sram Kimono (Epic, sin MP) ganaba sobre Crabby Breastplate (Legendario, sin MP) en build "full"

**ACTUALIZACI√ìN**: Sistema de scoring completamente reorganizado seg√∫n an√°lisis del usuario

---

## üêõ Bugs Cr√≠ticos Corregidos y Reorganizaci√≥n

### 1. **Power Bonus No Se Agregaba al Score** ‚úÖ CR√çTICO
**Archivo**: `api/app/services/solver.py` l√≠nea 431

**Antes:**
```python
item_score = stat_score - lambda_weight * item.difficulty - missing_stat_penalty + rarity_bonus + slot_fill_bonus
```

**Despu√©s:**
```python
item_score = stat_score + power_bonus - lambda_weight * item.difficulty - missing_stat_penalty + rarity_bonus + slot_fill_bonus
```

**Impacto**: El `power_bonus` se calculaba pero nunca se usaba. Ahora se agrega correctamente al score.

---

### 2. **Duplicaci√≥n de Stats en Scoring** ‚úÖ CR√çTICO  
**Archivo**: `api/app/services/solver.py` l√≠neas 259-338

**Problema**: Los stats solicitados por el usuario se contaban DOS veces:
1. En `stat_score` con el peso del usuario (ej: Fire_Mastery √ó 7 = 2,100 puntos)
2. En `item_power` con factor normalizado (ej: Fire_Mastery √ó 1.5 √ó 0.1 = 45 puntos)

**Soluci√≥n**: 
- `stat_score`: Cuenta SOLO los stats que el usuario pidi√≥ con sus pesos
- `item_power`: Cuenta SOLO los stats que el usuario NO pidi√≥ (stats "extra")

**Cambios en item_power**:
```python
# ANTES: Contaba stats si el usuario los pidi√≥
if "Fire_Mastery" in stat_weights:
    item_power += mastery_value * 1.5

# AHORA: Solo cuenta stats NO solicitados
if "Fire_Mastery" not in stat_weights:
    item_power += mastery_value * 1.0
```

**Factor final**: `√ó 0.05` (reducido de 0.1) para bonus m√°s sutil

---

### 3. **Penalties para AP/MP Faltantes Aumentadas** ‚úÖ
**Archivo**: `api/app/services/solver.py` l√≠neas 355, 379

**Antes**: 
```python
base_penalty = stat_weight √ó 10
# Ejemplo: MP=6 ‚Üí penalty ~57 puntos (muy bajo)
```

**Ahora**:
```python
base_penalty = stat_weight √ó 200
# Ejemplo: MP=6 ‚Üí penalty ~1,197 puntos (significativo)
```

**Slots afectados**:
- **CHEST/LEGS**: Penaliza fuertemente la falta de MP
- **BACK/NECK**: Penaliza fuertemente la falta de AP

**Compensaci√≥n**: Si tiene AP en lugar de MP (o viceversa), reduce penalty en 30% del valor

---

## üìä Ejemplo: Crabby vs Kimono (Actualizado)

### User Weights:
- AP: 10, MP: 6
- Fire_Mastery: 7, Earth_Mastery: 7
- Melee_Mastery: 10, Critical_Mastery: 8
- Critical_Hit: 9, Lock: 6

### Crabby Breastplate (Legendario):
**Stats**: AP=1, HP=210, Lock=40, Dodge=40, Fire_Mastery=122, Earth_Mastery=122, Resistances=138

**Score Breakdown**:
1. **stat_score** (stats solicitados):
   - AP: 1 √ó 10 = 10
   - Fire_Mastery: 122 √ó 7 = 854
   - Earth_Mastery: 122 √ó 7 = 854
   - Lock: 40 √ó 6 = 240
   - **Total: 1,958**

2. **power_bonus** (stats NO solicitados):
   - HP: 210 √ó 0.01 √ó 0.05 = 0.11
   - Dodge: 40 √ó 0.5 √ó 0.05 = 1.0
   - Resistencias: 138 √ó 1.2 √ó 0.05 = 8.28
   - **Total: ~9 puntos**

3. **missing_stat_penalty**:
   - MP faltante: 6 √ó 200 = 1,200
   - Compensaci√≥n AP: min(1 √ó 10 √ó 0.3, 600) = 3
   - **Penalty: -1,197**

4. **Score Final**: 1,958 + 9 - 1,197 = **770 puntos**

### Happy Sram Kimono (Epic):
**Stats**: AP=1, HP=362, Lock=50, Block=8, Fire_Mastery=88, Earth_Mastery=88, Air_Mastery=88, Resistances=60

**Score Breakdown**:
1. **stat_score** (stats solicitados):
   - AP: 1 √ó 10 = 10
   - Fire_Mastery: 88 √ó 7 = 616
   - Earth_Mastery: 88 √ó 7 = 616
   - Lock: 50 √ó 6 = 300
   - **Total: 1,542**

2. **power_bonus** (stats NO solicitados):
   - HP: 362 √ó 0.01 √ó 0.05 = 0.18
   - Air_Mastery: 88 √ó 1.0 √ó 0.05 = 4.4 (NO lo pidi√≥)
   - Block: 8 √ó 5 √ó 0.05 = 2.0
   - Resistencias: 60 √ó 1.2 √ó 0.05 = 3.6
   - **Total: ~10 puntos**

3. **missing_stat_penalty**:
   - **Penalty: -1,197** (igual que Crabby)

4. **Score Final**: 1,542 + 10 - 1,197 = **355 puntos**

---

## ‚úÖ Resultado Final

**Crabby Breastplate**: 770 puntos  
**Happy Sram Kimono**: 355 puntos  

**Crabby gana por 415 puntos** ‚úÖ

Sin embargo, en el build "full", la combinaci√≥n:
- **Tal Kasha's Broadsword (Relic)** + Kimono
  
Puede seguir ganando sobre:
- **Ice Shushu Sword (Epic)** + Crabby

Porque el arma reliquia es MUCHO mejor (210 mastery vs 70 mastery = +980 puntos solo en Fire_Mastery).

---

## üîß Archivos Modificados

### api/app/services/solver.py
| L√≠neas | Cambio |
|--------|--------|
| 259-338 | Item power: Solo stats NO solicitados (√ó0.05 final) |
| 355 | AP penalty: √ó10 ‚Üí √ó200 (BACK/NECK) |
| 379 | MP penalty: √ó10 ‚Üí √ó200 (CHEST/LEGS) |
| 431 | Score final: Agregado `+ power_bonus` |

---

## üöÄ Pr√≥ximos Pasos

1. **Reiniciar la API** para aplicar los cambios
2. **Probar build nivel 155** con el mismo payload
3. **Verificar** que los scores sean consistentes con la nueva l√≥gica

---

**Status**: ‚úÖ **COMPLETADO Y LISTO PARA TESTING**  
**Fecha**: 2025-11-05  
**Cambios**: 3 fixes cr√≠ticos aplicados

